"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.fixLineEndings = void 0;
// This Source Code Form is subject to the terms of the Mozilla Public
// License, v. 2.0. If a copy of the MPL was not distributed with this
// file, You can obtain one at http://mozilla.org/MPL/2.0/.
const fs_1 = require("fs");
const path_1 = require("path");
const log_1 = require("../log");
const constants_1 = require("../constants");
const utils_1 = require("../utils");
const fixLineEndings = async () => {
    let patches = (0, fs_1.readdirSync)(constants_1.PATCHES_DIR);
    patches = patches.filter((p) => p !== '.index');
    await Promise.all(patches.map(async (patch) => {
        const patchContents = (0, fs_1.readFileSync)((0, path_1.resolve)(constants_1.PATCHES_DIR, patch), 'utf-8');
        const originalPath = patchContents
            .split('diff --git a/')[1]
            .split(' b/')[0];
        if ((0, fs_1.existsSync)((0, path_1.resolve)(constants_1.ENGINE_DIR, originalPath))) {
            (0, utils_1.dispatch)('dos2unix', [originalPath], constants_1.ENGINE_DIR).then(async (_) => {
                await (0, utils_1.dispatch)('dos2unix', [patch], constants_1.PATCHES_DIR);
            });
        }
        else {
            log_1.log.warning(`Skipping ${patch} as it no longer exists in tree...`);
        }
    }));
};
exports.fixLineEndings = fixLineEndings;
